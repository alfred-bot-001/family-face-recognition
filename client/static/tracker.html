<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººè„¸è·Ÿè¸ª - èˆµæœºè¿½è¸ª</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
        .eye-bar {
            width: 100%; height: 180px; margin-bottom: 12px; border-radius: 16px;
            background: #000; overflow: hidden; position: relative;
        }
        #eyesCanvas { width: 100%; height: 100%; display: block; }
        .servo-overlay {
            position: absolute; right: 10px; top: 10px;
            background: rgba(0,0,0,.62); border: 1px solid rgba(59,130,246,.35);
            color: #93c5fd; border-radius: 8px; padding: 6px 9px;
            font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #333; margin-bottom: 16px;
        }
        header h1 { font-size: 1.4rem; }
        .main-content { display: grid; grid-template-columns: 1fr 300px; gap: 16px; }
        .video-panel {
            background: #1a1a1a; border-radius: 12px; overflow: hidden; position: relative;
        }
        .video-panel img {
            width: 100%; display: block; aspect-ratio: 4/3; object-fit: contain; background: #000;
        }
        .tracking-overlay {
            position: absolute; top: 8px; left: 8px;
            background: rgba(0,0,0,0.75); padding: 8px 14px; border-radius: 8px;
        }
        .tracking-target {
            font-size: 1.1rem; font-weight: 700;
        }
        .tracking-target.active { color: #ffeb3b; }
        .tracking-target.idle { color: #888; }
        .tracking-info { font-size: 0.8rem; color: #aaa; margin-top: 4px; font-family: monospace; }
        .sidebar { display: flex; flex-direction: column; gap: 12px; }
        .card {
            background: #1a1a1a; border-radius: 12px; padding: 16px;
        }
        .card h2 { font-size: 0.95rem; font-weight: 600; margin-bottom: 10px; color: #aaa; }
        .gimbal-display {
            text-align: center; padding: 12px;
            background: #252525; border-radius: 8px; margin-bottom: 10px;
        }
        .gimbal-angle { font-size: 1.8rem; font-weight: 700; color: #4caf50; font-family: monospace; }
        .gimbal-label { font-size: 0.7rem; color: #666; }
        .gimbal-row { display: flex; gap: 8px; }
        .gimbal-row > div { flex: 1; }
        .btn {
            display: block; width: 100%; padding: 10px; margin-top: 8px;
            background: #333; border: none; color: #e0e0e0; border-radius: 8px;
            cursor: pointer; font-size: 0.9rem;
        }
        .btn:hover { background: #444; }
        .face-item {
            padding: 8px 12px; background: #252525; border-radius: 8px;
            margin-bottom: 6px; display: flex; justify-content: space-between;
            border-left: 3px solid #4caf50;
        }
        .face-item.tracking { border-left-color: #ffeb3b; background: #2a2a1a; }
        .face-item.unknown { border-left-color: #f44336; }
        .priority-list { font-size: 0.85rem; color: #888; }
        .priority-list span { color: #ffeb3b; font-weight: 600; }
        .log-panel {
            max-height: 200px; overflow-y: auto;
            font-size: 0.75rem; font-family: monospace;
        }
        .log-entry { padding: 3px 0; border-bottom: 1px solid #222; }
        .log-entry .log-time { color: #555; }
        .log-entry .log-level-ERROR { color: #f44336; font-weight: 700; }
        .log-entry .log-level-INFO { color: #4caf50; }
        .log-entry .log-level-WARN { color: #ff9800; }
        .log-entry .log-msg { color: #ccc; }
        .vol-btn {
            width: 36px; height: 36px; border-radius: 50%; border: none;
            background: #333; color: #e0e0e0; font-size: 1.2rem; cursor: pointer;
        }
        .vol-btn:hover { background: #444; }
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="eye-bar">
            <canvas id="eyesCanvas"></canvas>
            <div class="servo-overlay" id="servoText">pan: --Â°<br>tilt: --Â°</div>
        </div>
        <header>
            <h1>ğŸ¯ äººè„¸è·Ÿè¸ª</h1>
            <div class="priority-list">
                ä¼˜å…ˆçº§: <span>son</span> > <span>max</span> > <span>wife</span>
            </div>
        </header>
        <div class="main-content">
            <div class="video-panel">
                <img id="videoStream" src="/video_feed" alt="è§†é¢‘æµ">
                <div class="tracking-overlay">
                    <div class="tracking-target idle" id="trackingTarget">ç­‰å¾…ç›®æ ‡...</div>
                    <div class="tracking-info" id="trackingInfo"></div>
                </div>
                <div id="xiaozhiBox" style="background:#1a1a2e;border-top:1px solid #333;padding:8px 12px;max-height:150px;overflow-y:auto;font-size:0.85em;line-height:1.5">
                    <div style="color:#888;margin-bottom:4px">ğŸ—£ï¸ å°æ™ºå¯¹è¯ <span id="xiaozhiStatus" style="font-size:0.8em">ğŸ‘‚ ç›‘å¬ä¸­</span></div>
                    <div id="xiaozhiPanel" style="color:#b0e0b0"></div>
                </div>
            </div>
            <div class="sidebar">
                <div class="card">
                    <h2>ğŸ”§ èˆµæœºçŠ¶æ€</h2>
                    <div class="gimbal-row">
                        <div class="gimbal-display">
                            <div class="gimbal-angle" id="panAngle">0Â°</div>
                            <div class="gimbal-label">æ°´å¹³ (Pan)</div>
                        </div>
                        <div class="gimbal-display">
                            <div class="gimbal-angle" id="tiltAngle">0Â°</div>
                            <div class="gimbal-label">å‚ç›´ (Tilt)</div>
                        </div>
                    </div>
                    <button class="btn" onclick="gimbalCenter()">ğŸ  å›ä¸­</button>
                    <button class="btn" onclick="gimbalCalibrate()" style="background:#1e3a5f">ğŸ”§ æ ¡å‡†ï¼ˆå½“å‰=0Â°ï¼‰</button>
                </div>
                <div class="card">
                    <h2>ğŸ”Š éŸ³é‡</h2>
                    <div style="display:flex;align-items:center;gap:8px">
                        <button class="vol-btn" onclick="setVol(-10)">âˆ’</button>
                        <div style="flex:1;background:#252525;border-radius:8px;height:24px;overflow:hidden">
                            <div id="volBar" style="height:100%;background:#4caf50;border-radius:8px;transition:width .2s;width:50%"></div>
                        </div>
                        <span id="volText" style="min-width:36px;text-align:center;font-family:monospace">50%</span>
                        <button class="vol-btn" onclick="setVol(10)">+</button>
                    </div>
                </div>
                <div class="card">
                    <h2>ğŸ§‘ æ£€æµ‹åˆ°çš„äººè„¸</h2>
                    <div id="faceList"></div>
                </div>
                <div class="card">
                    <h2>ğŸ‘‹ æ‰‹åŠ¿çŠ¶æ€</h2>
                    <div id="gestureStatus" style="text-align:center;padding:8px;color:#888">ç­‰å¾…æ£€æµ‹...</div>
                </div>
                <div class="card">
                    <h2>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h2>
                    <div class="log-panel" id="logPanel"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const trackingTarget = document.getElementById('trackingTarget');
        const trackingInfo = document.getElementById('trackingInfo');
        const panAngle = document.getElementById('panAngle');
        const tiltAngle = document.getElementById('tiltAngle');
        const faceList = document.getElementById('faceList');
        const servoText = document.getElementById('servoText');

        // ===== LOOI-style Robot Eyes =====
        const canvas = document.getElementById('eyesCanvas');
        const ctx = canvas.getContext('2d');
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        let targetX = 0, targetY = 0, lookX = 0, lookY = 0;
        let blinkL = 0, blinkR = 0;
        let nextBlink = performance.now() + 2000 + Math.random() * 2000;
        // Emotion state: normal, happy, sad, surprised, sleepy, angry, confused, love
        let emotion = 'normal', emotionT = 0;
        // Smooth emotion params (current/target)
        let eSquint = 0, tSquint = 0;    // >0 = happy squint (bottom eyelid up)
        let eWide = 0, tWide = 0;        // >0 = surprised wide
        let eDroop = 0, tDroop = 0;      // >0 = sleepy droop (top eyelid down)
        let eBrowAnger = 0, tBrowAnger = 0; // >0 = angry brow

        function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
        function resizeEyes(){ const r=canvas.getBoundingClientRect(); canvas.width=Math.max(10,Math.floor(r.width*dpr)); canvas.height=Math.max(10,Math.floor(r.height*dpr)); }

        function setServoDirection(pan=0, tilt=0){
            targetX = clamp((+pan || 0) / 60, -1, 1);
            targetY = clamp(-((+tilt || 0)) / 40, -1, 1);
        }

        function setEmotion(name, durationMs){
            emotion = name; emotionT = performance.now() + (durationMs || 3000);
            switch(name){
                case 'happy':    tSquint=1; tWide=0; tDroop=0; tBrowAnger=0; break;
                case 'sad':      tSquint=0; tWide=0; tDroop=0.5; tBrowAnger=0; break;
                case 'surprised':tSquint=0; tWide=1; tDroop=0; tBrowAnger=0; break;
                case 'sleepy':   tSquint=0; tWide=0; tDroop=0.8; tBrowAnger=0; break;
                case 'angry':    tSquint=0.3; tWide=0; tDroop=0; tBrowAnger=1; break;
                case 'love':     tSquint=0.6; tWide=0; tDroop=0; tBrowAnger=0; break;
                case 'confused': tSquint=0; tWide=0.4; tDroop=0; tBrowAnger=0; break;
                default:         tSquint=0; tWide=0; tDroop=0; tBrowAnger=0;
            }
        }

        function drawEyes(ts){
            const w = canvas.width, h = canvas.height;
            // Smooth look
            lookX += (targetX - lookX) * 0.12;
            lookY += (targetY - lookY) * 0.12;
            // Auto-blink
            if(ts > nextBlink){ blinkL = blinkR = 1; nextBlink = ts + 2200 + Math.random() * 2500; }
            blinkL += (0 - blinkL) * 0.18;
            blinkR += (0 - blinkR) * 0.18;
            // Emotion auto-reset
            if(emotion !== 'normal' && ts > emotionT){ setEmotion('normal'); }
            // Smooth emotion params
            const S = 0.08;
            eSquint += (tSquint - eSquint) * S;
            eWide += (tWide - eWide) * S;
            eDroop += (tDroop - eDroop) * S;
            eBrowAnger += (tBrowAnger - eBrowAnger) * S;

            ctx.clearRect(0, 0, w, h);
            const gap = w * 0.13; // gap between eyes
            const cxL = w * 0.5 - gap, cxR = w * 0.5 + gap;
            const cy = h * 0.52;
            const R = Math.min(w * 0.14, h * 0.42, 80 * dpr); // big eye radius
            const pupilR = R * 0.38;
            const px = lookX * R * 0.55, py = lookY * R * 0.4;

            function drawEye(cx, blinkVal, isLeft){
                ctx.save();
                const openTop = Math.max(0.05, 1 - blinkVal * 0.95 - eDroop * 0.45 - eBrowAnger * 0.2);
                const openBot = Math.max(0.05, 1 - blinkVal * 0.95 - eSquint * 0.4);
                const scaleY = (1 + eWide * 0.12);
                const ex = cx + px, ey = cy + py;

                // LOOI style: solid color cartoon eye, no pupil, no white
                ctx.beginPath();
                ctx.ellipse(ex, ey, R, R * openTop * scaleY, 0, Math.PI, 0);
                ctx.ellipse(ex, ey, R, R * openBot * scaleY, 0, 0, Math.PI);
                ctx.closePath();
                // Soft radial gradient for depth
                const g = ctx.createRadialGradient(ex - R*0.2, ey - R*0.2, R*0.05, ex, ey, R);
                g.addColorStop(0, '#93c5fd');
                g.addColorStop(0.5, '#3b82f6');
                g.addColorStop(1, '#1d4ed8');
                ctx.fillStyle = g;
                ctx.fill();

                // Big highlight (top-left)
                ctx.beginPath(); ctx.arc(ex - R*0.22, ey - R*0.22, R*0.17, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.fill();
                // Small highlight (bottom-right)
                ctx.beginPath(); ctx.arc(ex + R*0.15, ey + R*0.18, R*0.07, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.fill();

                // Angry brow
                if(eBrowAnger > 0.05){
                    ctx.globalAlpha = eBrowAnger;
                    ctx.strokeStyle = '#64748b'; ctx.lineWidth = R * 0.1; ctx.lineCap = 'round';
                    const by = ey - R * openTop * scaleY - R * 0.15;
                    const angle = isLeft ? 0.35 : -0.35;
                    ctx.beginPath();
                    ctx.moveTo(cx - R*0.7, by + Math.sin(angle)*R*0.35);
                    ctx.lineTo(cx + R*0.7, by - Math.sin(angle)*R*0.35);
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                }
                ctx.restore();

                // Love hearts
                if(emotion === 'love' && eSquint > 0.3){
                    ctx.save(); ctx.globalAlpha = eSquint * 0.7;
                    ctx.fillStyle = '#f472b6';
                    ctx.font = `${R*0.4}px serif`;
                    ctx.fillText('â™¥', cx + R*0.8, cy - R*0.6);
                    ctx.restore();
                }
            }

            drawEye(cxL, blinkL, true);
            drawEye(cxR, blinkR, false);

            // Confused: one eye slightly higher
            // (handled naturally by slight tilt)

            requestAnimationFrame(drawEyes);
        }

        window.setServoDirection = setServoDirection;
        window.setEmotion = setEmotion;
        window.addEventListener('resize', resizeEyes);
        resizeEyes(); requestAnimationFrame(drawEyes);

        async function pollStatus() {
            try {
                const r = await fetch('/api/status?t=' + Date.now(), {cache:'no-store'});
                const d = await r.json();
                if (d.tracking) {
                    trackingTarget.className = 'tracking-target active';
                    trackingTarget.textContent = `ğŸ¯ ${d.tracking}`;
                    trackingInfo.textContent = `ç½®ä¿¡åº¦: ${(d.confidence*100).toFixed(1)}%`;
                } else {
                    trackingTarget.className = 'tracking-target idle';
                    trackingTarget.textContent = 'æœç´¢ä¸­...';
                    trackingInfo.textContent = '';
                }
                // æ‰‹åŠ¿
                const gs = d.gesture || {};
                const gestureEl = document.getElementById('gestureStatus');
                if (gs.wave_detected) {
                    gestureEl.innerHTML = '<span style="font-size:1.5rem">ğŸ‘‹</span> æŒ¥æ‰‹æ£€æµ‹åˆ°ï¼';
                    gestureEl.style.color = '#ffeb3b';
                } else if (gs.hands_count > 0) {
                    const g = gs.gesture || 'unknown';
                    const text = g === 'open_palm' ? 'ğŸ–ï¸ æ‰‹æŒå¼ å¼€' : (g === 'fist' ? 'âœŠ æ¡æ‹³' : `âœ‹ ${g}`);
                    gestureEl.innerHTML = `${text} (${gs.hands_count}åªæ‰‹)`;
                    gestureEl.style.color = (g === 'open_palm') ? '#00e676' : '#4caf50';
                } else {
                    gestureEl.innerHTML = 'æœªæ£€æµ‹åˆ°æ‰‹';
                    gestureEl.style.color = '#555';
                }
                const pan = (typeof d.pan === 'number') ? d.pan : ((typeof d.pan_angle === 'number') ? d.pan_angle : 0);
                const tilt = (typeof d.tilt === 'number') ? d.tilt : ((typeof d.tilt_angle === 'number') ? d.tilt_angle : 0);
                panAngle.textContent = `${pan}Â°`;
                tiltAngle.textContent = `${tilt}Â°`;
                servoText.innerHTML = `pan: ${Number(pan).toFixed(1)}Â°<br>tilt: ${Number(tilt).toFixed(1)}Â°`;
                setServoDirection(pan, tilt);
                // Emotion triggers
                const faces = d.faces || [];
                const known = faces.filter(f => f.name !== 'unknown');
                if (faces.length === 0 && emotion === 'normal') { setEmotion('sleepy', 2000); }
                else if (known.length > 0 && emotion === 'normal') { setEmotion('happy', 1500); }
                const gs2 = d.gesture || {};
                if (gs2.wave_detected) { setEmotion('surprised', 2000); }
                else if (gs2.gesture === 'open_palm' && emotion === 'normal') { setEmotion('love', 2500); }

                if (faces.length === 0) {
                    faceList.innerHTML = '<div style="color:#555;text-align:center;padding:16px">æœªæ£€æµ‹åˆ°äººè„¸</div>';
                } else {
                    faceList.innerHTML = faces.map(f => {
                        const cls = f.name === d.tracking ? 'face-item tracking' :
                                    f.name === 'unknown' ? 'face-item unknown' : 'face-item';
                        return `<div class="${cls}">
                            <span>${f.name === d.tracking ? 'ğŸ¯ ' : ''}${f.name}</span>
                            <span style="color:#888">${(f.confidence*100).toFixed(1)}%</span>
                        </div>`;
                    }).join('');
                }
            } catch(e) {}
        }
        async function gimbalCenter() {
            await fetch('/api/gimbal/center', {method:'POST'});
        }
        async function gimbalCalibrate() {
            await fetch('/api/gimbal/calibrate', {method:'POST'});
        }
        const logPanel = document.getElementById('logPanel');
        async function pollLogs() {
            try {
                const r = await fetch('/api/logs?t=' + Date.now(), {cache:'no-store'});
                const logs = await r.json();
                logPanel.innerHTML = logs.map(l =>
                    `<div class="log-entry"><span class="log-time">${l.time}</span> <span class="log-level-${l.level}">[${l.level}]</span> <span class="log-msg">${l.msg}</span></div>`
                ).join('');
            } catch(e) {}
        }
        let currentVol = 50;
        async function fetchVol() {
            try {
                const r = await fetch('/api/volume');
                const d = await r.json();
                if (d.volume >= 0) { currentVol = d.volume; updateVolUI(); }
            } catch(e) {}
        }
        function updateVolUI() {
            document.getElementById('volBar').style.width = currentVol + '%';
            document.getElementById('volText').textContent = currentVol + '%';
        }
        async function setVol(delta) {
            currentVol = Math.max(0, Math.min(100, currentVol + delta));
            updateVolUI();
            await fetch('/api/volume', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({volume:currentVol})});
        }
        // å°æ™ºå¯¹è¯æ—¥å¿—
        const xiaozhiPanel = document.getElementById('xiaozhiPanel');
        async function pollXiaozhi() {
            try {
                const r = await fetch('/api/xiaozhi/logs?t=' + Date.now(), {cache:'no-store'});
                const d = await r.json();
                const shown = d.lines
                    .filter(l => (l.includes('[INFO]') || l.includes('[ERROR]')) && !l.includes('[debug] audio chunks'));
                xiaozhiPanel.innerHTML = shown
                    .map(l => {
                        let cls = '';
                        if (l.includes('å”¤é†’') || l.includes('ğŸ¯')) cls = 'color:#ffeb3b';
                        else if (l.includes('ERROR') || l.includes('è¿æ¥æ–­å¼€') || l.includes('è¿æ¥å¤±è´¥')) cls = 'color:#f44336';
                        else if (l.includes('asr:') || l.includes('asr final:') || l.includes('ğŸ¤ è¯†åˆ«')) cls = 'color:#90caf9';
                        else if (l.includes('ğŸ¤–') || l.includes('ğŸ’¬')) cls = 'color:#a5d6a7';
                        return `<div style="${cls}">${l.replace(/</g,'&lt;')}</div>`;
                    }).join('');
                xiaozhiPanel.scrollTop = xiaozhiPanel.scrollHeight;
                // çŠ¶æ€ï¼ˆä»æœ€è¿‘æ—¥å¿—åæ¨ï¼‰
                const last = shown[shown.length - 1] || '';
                const st = document.getElementById('xiaozhiStatus');
                if (last.includes('ç›‘å¬å”¤é†’è¯') || last.includes('ç»§ç»­ç›‘å¬')) st.textContent = 'ğŸ‘‚ ç›‘å¬ä¸­';
                else if (last.includes('å”¤é†’è¯è§¦å‘') || last.includes('å½•éŸ³ä¸­') || last.includes('æœåŠ¡ç«¯å¼€å§‹è¯´è¯')) st.textContent = 'ğŸ™ï¸ å¯¹è¯ä¸­';
                else if (last.includes('åœæ­¢å½•éŸ³') || last.includes('æœåŠ¡ç«¯è¯´è¯ç»“æŸ')) st.textContent = 'âœ… å®Œæˆ';
            } catch(e) {}
        }
        setInterval(pollXiaozhi, 2000);
        pollXiaozhi();
        fetchVol();
        setInterval(pollStatus, 800);
        setInterval(pollLogs, 2000);
        pollStatus();
        pollLogs();
        document.getElementById('videoStream').onerror = function() {
            setTimeout(() => { this.src = '/video_feed?' + Date.now(); }, 2000);
        };
    </script>
</body>
</html>
