<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººè„¸è·Ÿè¸ª - èˆµæœºè¿½è¸ª</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #333; margin-bottom: 16px;
        }
        header h1 { font-size: 1.4rem; }
        .main-content { display: grid; grid-template-columns: 1fr 300px; gap: 16px; }
        .video-panel {
            background: #1a1a1a; border-radius: 12px; overflow: hidden; position: relative;
        }
        .video-panel img {
            width: 100%; display: block; aspect-ratio: 4/3; object-fit: contain; background: #000;
        }
        .tracking-overlay {
            position: absolute; top: 8px; left: 8px;
            background: rgba(0,0,0,0.75); padding: 8px 14px; border-radius: 8px;
        }
        .tracking-target {
            font-size: 1.1rem; font-weight: 700;
        }
        .tracking-target.active { color: #ffeb3b; }
        .tracking-target.idle { color: #888; }
        .tracking-info { font-size: 0.8rem; color: #aaa; margin-top: 4px; font-family: monospace; }
        .sidebar { display: flex; flex-direction: column; gap: 12px; }
        .card {
            background: #1a1a1a; border-radius: 12px; padding: 16px;
        }
        .card h2 { font-size: 0.95rem; font-weight: 600; margin-bottom: 10px; color: #aaa; }
        .gimbal-display {
            text-align: center; padding: 12px;
            background: #252525; border-radius: 8px; margin-bottom: 10px;
        }
        .gimbal-angle { font-size: 1.8rem; font-weight: 700; color: #4caf50; font-family: monospace; }
        .gimbal-label { font-size: 0.7rem; color: #666; }
        .gimbal-row { display: flex; gap: 8px; }
        .gimbal-row > div { flex: 1; }
        .btn {
            display: block; width: 100%; padding: 10px; margin-top: 8px;
            background: #333; border: none; color: #e0e0e0; border-radius: 8px;
            cursor: pointer; font-size: 0.9rem;
        }
        .btn:hover { background: #444; }
        .face-item {
            padding: 8px 12px; background: #252525; border-radius: 8px;
            margin-bottom: 6px; display: flex; justify-content: space-between;
            border-left: 3px solid #4caf50;
        }
        .face-item.tracking { border-left-color: #ffeb3b; background: #2a2a1a; }
        .face-item.unknown { border-left-color: #f44336; }
        .priority-list { font-size: 0.85rem; color: #888; }
        .priority-list span { color: #ffeb3b; font-weight: 600; }
        .log-panel {
            max-height: 200px; overflow-y: auto;
            font-size: 0.75rem; font-family: monospace;
        }
        .log-entry { padding: 3px 0; border-bottom: 1px solid #222; }
        .log-entry .log-time { color: #555; }
        .log-entry .log-level-ERROR { color: #f44336; font-weight: 700; }
        .log-entry .log-level-INFO { color: #4caf50; }
        .log-entry .log-level-WARN { color: #ff9800; }
        .log-entry .log-msg { color: #ccc; }
        .vol-btn {
            width: 36px; height: 36px; border-radius: 50%; border: none;
            background: #333; color: #e0e0e0; font-size: 1.2rem; cursor: pointer;
        }
        .vol-btn:hover { background: #444; }
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¯ äººè„¸è·Ÿè¸ª</h1>
            <div class="priority-list">
                ä¼˜å…ˆçº§: <span>son</span> > <span>max</span> > <span>wife</span>
            </div>
        </header>
        <div class="main-content">
            <div class="video-panel">
                <img id="videoStream" src="/video_feed" alt="è§†é¢‘æµ">
                <div class="tracking-overlay">
                    <div class="tracking-target idle" id="trackingTarget">ç­‰å¾…ç›®æ ‡...</div>
                    <div class="tracking-info" id="trackingInfo"></div>
                </div>
                <div id="xiaozhiBox" style="background:#1a1a2e;border-top:1px solid #333;padding:8px 12px;max-height:150px;overflow-y:auto;font-size:0.85em;line-height:1.5">
                    <div style="color:#888;margin-bottom:4px">ğŸ—£ï¸ å°æ™ºå¯¹è¯ <span id="xiaozhiStatus" style="font-size:0.8em">âœ‹ ç­‰å¾…æ‰‹æŒ</span></div>
                    <div id="xiaozhiPanel" style="color:#b0e0b0"></div>
                </div>
            </div>
            <div class="sidebar">
                <div class="card">
                    <h2>ğŸ”§ èˆµæœºçŠ¶æ€</h2>
                    <div class="gimbal-row">
                        <div class="gimbal-display">
                            <div class="gimbal-angle" id="panAngle">0Â°</div>
                            <div class="gimbal-label">æ°´å¹³ (Pan)</div>
                        </div>
                        <div class="gimbal-display">
                            <div class="gimbal-angle" id="tiltAngle">0Â°</div>
                            <div class="gimbal-label">å‚ç›´ (Tilt)</div>
                        </div>
                    </div>
                    <button class="btn" onclick="gimbalCenter()">ğŸ  å›ä¸­</button>
                </div>
                <div class="card">
                    <h2>ğŸ”Š éŸ³é‡</h2>
                    <div style="display:flex;align-items:center;gap:8px">
                        <button class="vol-btn" onclick="setVol(-10)">âˆ’</button>
                        <div style="flex:1;background:#252525;border-radius:8px;height:24px;overflow:hidden">
                            <div id="volBar" style="height:100%;background:#4caf50;border-radius:8px;transition:width .2s;width:50%"></div>
                        </div>
                        <span id="volText" style="min-width:36px;text-align:center;font-family:monospace">50%</span>
                        <button class="vol-btn" onclick="setVol(10)">+</button>
                    </div>
                </div>
                <div class="card">
                    <h2>ğŸ§‘ æ£€æµ‹åˆ°çš„äººè„¸</h2>
                    <div id="faceList"></div>
                </div>
                <div class="card">
                    <h2>ğŸ‘‹ æ‰‹åŠ¿çŠ¶æ€</h2>
                    <div id="gestureStatus" style="text-align:center;padding:8px;color:#888">ç­‰å¾…æ£€æµ‹...</div>
                </div>
                <div class="card">
                    <h2>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h2>
                    <div class="log-panel" id="logPanel"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const trackingTarget = document.getElementById('trackingTarget');
        const trackingInfo = document.getElementById('trackingInfo');
        const panAngle = document.getElementById('panAngle');
        const tiltAngle = document.getElementById('tiltAngle');
        const faceList = document.getElementById('faceList');

        async function pollStatus() {
            try {
                const r = await fetch('/api/status');
                const d = await r.json();
                if (d.tracking) {
                    trackingTarget.className = 'tracking-target active';
                    trackingTarget.textContent = `ğŸ¯ ${d.tracking}`;
                    trackingInfo.textContent = `ç½®ä¿¡åº¦: ${(d.confidence*100).toFixed(1)}%`;
                } else {
                    trackingTarget.className = 'tracking-target idle';
                    trackingTarget.textContent = 'æœç´¢ä¸­...';
                    trackingInfo.textContent = '';
                }
                // æ‰‹åŠ¿
                const gs = d.gesture || {};
                const gestureEl = document.getElementById('gestureStatus');
                if (gs.wave_detected) {
                    gestureEl.innerHTML = '<span style="font-size:1.5rem">ğŸ‘‹</span> æŒ¥æ‰‹æ£€æµ‹åˆ°ï¼';
                    gestureEl.style.color = '#ffeb3b';
                } else if (gs.hands_count > 0) {
                    const palm = (gs.hand_landmarks||[]).some(h=>h.palm_open) ? 'ğŸ–ï¸ æ‰‹æŒå¼ å¼€' : 'âœŠ æ¡æ‹³';
                    gestureEl.innerHTML = `${palm} (${gs.hands_count}åªæ‰‹)`;
                    gestureEl.style.color = '#4caf50';
                } else {
                    gestureEl.innerHTML = 'æœªæ£€æµ‹åˆ°æ‰‹';
                    gestureEl.style.color = '#555';
                }
                panAngle.textContent = `${d.pan || 0}Â°`;
                tiltAngle.textContent = `${d.tilt || 0}Â°`;
                const faces = d.faces || [];
                if (faces.length === 0) {
                    faceList.innerHTML = '<div style="color:#555;text-align:center;padding:16px">æœªæ£€æµ‹åˆ°äººè„¸</div>';
                } else {
                    faceList.innerHTML = faces.map(f => {
                        const cls = f.name === d.tracking ? 'face-item tracking' :
                                    f.name === 'unknown' ? 'face-item unknown' : 'face-item';
                        return `<div class="${cls}">
                            <span>${f.name === d.tracking ? 'ğŸ¯ ' : ''}${f.name}</span>
                            <span style="color:#888">${(f.confidence*100).toFixed(1)}%</span>
                        </div>`;
                    }).join('');
                }
            } catch(e) {}
        }
        async function gimbalCenter() {
            await fetch('/api/gimbal/center', {method:'POST'});
        }
        const logPanel = document.getElementById('logPanel');
        async function pollLogs() {
            try {
                const r = await fetch('/api/logs');
                const logs = await r.json();
                logPanel.innerHTML = logs.map(l =>
                    `<div class="log-entry"><span class="log-time">${l.time}</span> <span class="log-level-${l.level}">[${l.level}]</span> <span class="log-msg">${l.msg}</span></div>`
                ).join('');
            } catch(e) {}
        }
        let currentVol = 50;
        async function fetchVol() {
            try {
                const r = await fetch('/api/volume');
                const d = await r.json();
                if (d.volume >= 0) { currentVol = d.volume; updateVolUI(); }
            } catch(e) {}
        }
        function updateVolUI() {
            document.getElementById('volBar').style.width = currentVol + '%';
            document.getElementById('volText').textContent = currentVol + '%';
        }
        async function setVol(delta) {
            currentVol = Math.max(0, Math.min(100, currentVol + delta));
            updateVolUI();
            await fetch('/api/volume', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({volume:currentVol})});
        }
        // å°æ™ºå¯¹è¯æ—¥å¿—
        const xiaozhiPanel = document.getElementById('xiaozhiPanel');
        async function pollXiaozhi() {
            try {
                const r = await fetch('/api/xiaozhi/logs');
                const d = await r.json();
                const shown = d.lines
                    .filter(l => (l.includes('[INFO]') || l.includes('[ERROR]')) && !l.includes('[debug] audio chunks'));
                xiaozhiPanel.innerHTML = shown
                    .map(l => {
                        let cls = '';
                        if (l.includes('å”¤é†’') || l.includes('ğŸ¯')) cls = 'color:#ffeb3b';
                        else if (l.includes('ERROR') || l.includes('è¿æ¥æ–­å¼€') || l.includes('è¿æ¥å¤±è´¥')) cls = 'color:#f44336';
                        else if (l.includes('asr:') || l.includes('asr final:') || l.includes('ğŸ¤ è¯†åˆ«')) cls = 'color:#90caf9';
                        else if (l.includes('ğŸ¤–') || l.includes('ğŸ’¬')) cls = 'color:#a5d6a7';
                        return `<div style="${cls}">${l.replace(/</g,'&lt;')}</div>`;
                    }).join('');
                xiaozhiPanel.scrollTop = xiaozhiPanel.scrollHeight;
                // çŠ¶æ€ï¼ˆä»æœ€è¿‘æ—¥å¿—åæ¨ï¼‰
                const last = shown[shown.length - 1] || '';
                const st = document.getElementById('xiaozhiStatus');
                if (last.includes('æ‰‹æŒè§¦å‘æ¨¡å¼å·²å¯ç”¨') || last.includes('ç»§ç»­ç›‘å¬') || last.includes('ç›‘å¬å”¤é†’è¯')) st.textContent = 'âœ‹ ç­‰å¾…æ‰‹æŒ';
                else if (last.includes('æ‰‹æŒå‡ºç°') || last.includes('å½•éŸ³ä¸­') || last.includes('æœåŠ¡ç«¯å¼€å§‹è¯´è¯')) st.textContent = 'ğŸ™ï¸ å¯¹è¯ä¸­';
                else if (last.includes('æ‰‹æŒæ¶ˆå¤±') || last.includes('åœæ­¢å½•éŸ³') || last.includes('æœåŠ¡ç«¯è¯´è¯ç»“æŸ')) st.textContent = 'âœ… å®Œæˆ';
            } catch(e) {}
        }
        setInterval(pollXiaozhi, 2000);
        pollXiaozhi();
        fetchVol();
        setInterval(pollStatus, 800);
        setInterval(pollLogs, 2000);
        pollStatus();
        pollLogs();
        document.getElementById('videoStream').onerror = function() {
            setTimeout(() => { this.src = '/video_feed?' + Date.now(); }, 2000);
        };
    </script>
</body>
</html>
