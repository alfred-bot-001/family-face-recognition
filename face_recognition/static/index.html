<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å®¶åº­äººè„¸è¯†åˆ«</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f0f2f5; color: #333; min-height: 100vh; }
.container { max-width: 900px; margin: 0 auto; padding: 20px; }
h1 { text-align: center; margin: 20px 0; font-size: 28px; }
.card { background: #fff; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

/* ä¸Šä¼ åŒº */
.upload-zone {
  border: 2px dashed #d0d0d0; border-radius: 8px; padding: 40px; text-align: center;
  cursor: pointer; transition: all 0.2s; position: relative;
}
.upload-zone:hover, .upload-zone.dragover { border-color: #4a90d9; background: #f5f9ff; }
.upload-zone input { display: none; }
.upload-zone p { font-size: 16px; color: #888; }
.upload-zone .icon { font-size: 48px; margin-bottom: 10px; }

/* é¢„è§ˆ */
.preview-area { display: none; margin-top: 20px; text-align: center; position: relative; }
.preview-area img { max-width: 100%; max-height: 500px; border-radius: 8px; }
.preview-area canvas { position: absolute; top: 0; left: 0; pointer-events: none; }

/* æŒ‰é’® */
.btn { display: inline-block; padding: 12px 32px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.2s; }
.btn-primary { background: #4a90d9; color: #fff; }
.btn-primary:hover { background: #357abd; }
.btn-primary:disabled { background: #b0c4de; cursor: not-allowed; }
.btn-secondary { background: #e8e8e8; color: #555; margin-left: 10px; }
.btn-secondary:hover { background: #d0d0d0; }
.actions { text-align: center; margin-top: 20px; }

/* ç»“æœ */
.results { display: none; }
.result-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; }
.result-item:last-child { border-bottom: none; }
.result-name { font-size: 20px; font-weight: 600; flex: 1; }
.result-name.unknown { color: #e74c3c; }
.result-name.known { color: #27ae60; }
.result-meta { font-size: 14px; color: #888; text-align: right; }
.result-meta span { display: block; }
.confidence-bar { width: 120px; height: 6px; background: #eee; border-radius: 3px; margin-top: 4px; }
.confidence-fill { height: 100%; border-radius: 3px; }

.stats { text-align: center; padding: 10px; color: #888; font-size: 14px; }
.loading { display: none; text-align: center; padding: 20px; }
.loading .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid #eee; border-top-color: #4a90d9; border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* æ ‡æ³¨å›¾ */
.annotated-area { display: none; margin-top: 20px; text-align: center; }
.annotated-area img { max-width: 100%; max-height: 500px; border-radius: 8px; }
.tab-bar { display: flex; gap: 0; margin-bottom: 16px; }
.tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; color: #888; }
.tab.active { color: #4a90d9; border-bottom-color: #4a90d9; font-weight: 600; }
.tab-content { display: none; }
.tab-content.active { display: block; }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶åº­äººè„¸è¯†åˆ«</h1>

  <div class="card">
    <div class="upload-zone" id="dropZone">
      <div class="icon">ğŸ“·</div>
      <p>ç‚¹å‡»é€‰æ‹©ç…§ç‰‡ æˆ– æ‹–æ‹½åˆ°æ­¤å¤„</p>
      <input type="file" id="fileInput" accept="image/*">
    </div>

    <div class="preview-area" id="previewArea">
      <img id="previewImg">
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="recognizeBtn" disabled>ğŸ” å¼€å§‹è¯†åˆ«</button>
      <button class="btn btn-secondary" id="clearBtn" style="display:none">æ¸…é™¤</button>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p style="margin-top:10px">è¯†åˆ«ä¸­...</p>
    </div>
  </div>

  <div class="card results" id="resultsCard">
    <div class="tab-bar">
      <div class="tab active" data-tab="list">è¯†åˆ«ç»“æœ</div>
      <div class="tab" data-tab="annotated">æ ‡æ³¨å›¾ç‰‡</div>
    </div>

    <div class="tab-content active" id="tab-list">
      <div id="resultsList"></div>
      <div class="stats" id="stats"></div>
    </div>

    <div class="tab-content" id="tab-annotated">
      <div class="annotated-area" id="annotatedArea" style="display:block">
        <img id="annotatedImg">
      </div>
    </div>
  </div>
</div>

<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const previewArea = document.getElementById('previewArea');
const previewImg = document.getElementById('previewImg');
const recognizeBtn = document.getElementById('recognizeBtn');
const clearBtn = document.getElementById('clearBtn');
const loading = document.getElementById('loading');
const resultsCard = document.getElementById('resultsCard');
const resultsList = document.getElementById('resultsList');
const stats = document.getElementById('stats');
const annotatedImg = document.getElementById('annotatedImg');

let currentFile = null;

// ä¸Šä¼ åŒºäº¤äº’
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => { if (fileInput.files.length) handleFile(fileInput.files[0]); });

function handleFile(file) {
  if (!file.type.startsWith('image/')) return;
  currentFile = file;
  const reader = new FileReader();
  reader.onload = e => {
    previewImg.src = e.target.result;
    previewArea.style.display = 'block';
    dropZone.style.display = 'none';
    recognizeBtn.disabled = false;
    clearBtn.style.display = 'inline-block';
    resultsCard.style.display = 'none';
  };
  reader.readAsDataURL(file);
}

clearBtn.addEventListener('click', () => {
  currentFile = null;
  previewArea.style.display = 'none';
  dropZone.style.display = 'block';
  recognizeBtn.disabled = true;
  clearBtn.style.display = 'none';
  resultsCard.style.display = 'none';
  fileInput.value = '';
});

// Tab åˆ‡æ¢
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// è¯†åˆ«
recognizeBtn.addEventListener('click', async () => {
  if (!currentFile) return;

  recognizeBtn.disabled = true;
  loading.style.display = 'block';
  resultsCard.style.display = 'none';

  const formData = new FormData();
  formData.append('file', currentFile);

  try {
    // å¹¶è¡Œè¯·æ±‚ JSON ç»“æœå’Œæ ‡æ³¨å›¾
    const [jsonRes, imgRes] = await Promise.all([
      fetch('/recognize', { method: 'POST', body: formData }),
      fetch('/recognize/annotated', { method: 'POST', body: (() => { const fd = new FormData(); fd.append('file', currentFile); return fd; })() }),
    ]);

    const data = await jsonRes.json();
    const blob = await imgRes.blob();

    // æ˜¾ç¤ºç»“æœ
    resultsList.innerHTML = '';
    if (data.faces && data.faces.length > 0) {
      data.faces.forEach(face => {
        const isKnown = face.name !== 'unknown';
        const confPct = Math.round(face.confidence * 100);
        const barColor = isKnown ? '#27ae60' : '#e74c3c';

        resultsList.innerHTML += `
          <div class="result-item">
            <div class="result-name ${isKnown ? 'known' : 'unknown'}">
              ${isKnown ? 'âœ…' : 'â“'} ${face.name}
            </div>
            <div class="result-meta">
              <span>ç½®ä¿¡åº¦: ${(face.confidence * 100).toFixed(1)}%</span>
              <div class="confidence-bar"><div class="confidence-fill" style="width:${confPct}%;background:${barColor}"></div></div>
              <span>å¹´é¾„: ${face.age || '-'} | æ€§åˆ«: ${face.gender || '-'}</span>
            </div>
          </div>`;
      });
      stats.textContent = `æ£€æµ‹åˆ° ${data.count} å¼ äººè„¸ | è€—æ—¶ ${data.time_ms}ms`;
    } else {
      resultsList.innerHTML = '<p style="text-align:center;padding:20px;color:#888">æœªæ£€æµ‹åˆ°äººè„¸</p>';
      stats.textContent = `è€—æ—¶ ${data.time_ms}ms`;
    }

    // æ ‡æ³¨å›¾
    annotatedImg.src = URL.createObjectURL(blob);

    resultsCard.style.display = 'block';
  } catch (err) {
    alert('è¯†åˆ«è¯·æ±‚å¤±è´¥: ' + err.message);
  } finally {
    loading.style.display = 'none';
    recognizeBtn.disabled = false;
  }
});
</script>
</body>
</html>
